<script>
  // GLOBAL printReceipt — works perfectly
  function printReceipt(text) {
    const win = window.open('', '_blank', 'width=380,height=600');
    win.document.write(`
      <pre style="font-family:monospace;font-size:16px;line-height:1.4;margin:20px;">${text}</pre>
      <script>
        window.onload = () => { window.print(); window.close(); }
      <\/script>
    `);
    win.document.close();
  }

  // OPEN MODALS
  function openShoppingModal(family) {
    document.getElementById('shopControl').textContent = family.control_number;
    document.getElementById('shopKids').innerHTML = family.children.map(c => 
      `<strong>${c.gender} age ${c.age}</strong>` + (c.special_requests ? `<br><em class="text-danger">${c.special_requests}</em>` : '')
    ).join('<br>');
    new bootstrap.Modal(document.getElementById('shoppingModal')).show();
  }

  function openBagsModal(family) {
    document.getElementById('bagsControl').textContent = family.control_number;
    document.getElementById('numBags').value = 1;
    document.getElementById('binLocation').value = 'A12';
    new bootstrap.Modal(document.getElementById('bagsModal')).show();
  }

  function openPickupModal(family) {
    document.getElementById('pickupControl').textContent = family.control_number;
    document.getElementById('pickupBin').textContent = family.bin || 'Ask staff';
    new bootstrap.Modal(document.getElementById('pickupModal')).show();
  }

  // PRINT & SAVE — 100% WORKING
  async function printShoppingCard() {
    const control = document.getElementById('shopControl').textContent;
    const family = families.find(f => f.control_number === control);
    const kids = family.children.map(c => `${c.gender} age ${c.age}` + (c.special_requests ? ` — ${c.special_requests}` : '')).join('\n');
    printReceipt(`TOYS FOR TOTS SOUTH BREVARD\nCONTROL: ${control}\n${kids}\nThank you!`);

    await fetch("/api/finalize", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ control_number: control, status: "being_shopped" })
    });
    location.reload();
  }

  async function saveAndPrintBagLabels() {
    const control = document.getElementById('bagsControl').textContent;
    const bags = document.getElementById('numBags').value || 1;
    const bin = document.getElementById('binLocation').value.trim() || "UNKNOWN";

    for (let i = 1; i <= bags; i++) {
      printReceipt(`BAG LABEL\nControl: ${control}\nBag ${i} of ${bags}\nBin: ${bin}`);
    }

    await fetch("/api/finalize", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ control_number: control, status: "ready_for_pickup", bags, bin })
    });
    location.reload();
  }

  async function printPickupCard() {
    const control = document.getElementById('pickupControl').textContent;
    const bin = document.getElementById('pickupBin').textContent;
    printReceipt(`PICKUP READY!\nControl: ${control}\nBin Location: ${bin}\nThank you!`);

    await fetch("/api/finalize", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ control_number: control, status: "complete" })
    });
    location.reload();
  }
</script>

<!-- SHOPPING MODAL -->
<div class="modal fade" id="shoppingModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5>Start Shopping?</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <h4>#<span id="shopControl"></span></h4>
        <div id="shopKids" class="my-3"></div>
        <p class="lead">Print shopping card?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success btn-lg" onclick="printShoppingCard()">Print & Start</button>
      </div>
    </div>
  </div>
</div>

<!-- Being Shopped → Ready for Pickup + Toy Counts -->
<div class="modal fade" id="bagsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">Bags, Bin & Toy Counts</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h4 class="text-center mb-4">#<span id="bagsControl"></span></h4>

        <div class="row g-3">
          <div class="col-6 col-md-4">
            <label class="form-label fw-bold">Number of Bags</label>
            <input type="number" id="numBags" class="form-control form-control-lg text-center" min="1" value="1">
          </div>
          <div class="col-6 col-md-4">
            <label class="form-label fw-bold">Bin Location</label>
            <input type="text" id="binLocation" class="form-control form-control-lg text-center" value="A12">
          </div>
        </div>

        <hr class="my-4">

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold text-success">Total Toys Given</label>
            <input type="number" id="toysGiven" class="form-control form-control-lg text-center" min="0" value="0">
            <small class="text-muted">includes bikes & stuffies</small>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold text-primary">Books Given</label>
            <input type="number" id="booksGiven" class="form-control form-control-lg text-center" min="0" value="0">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label fw-bold text-danger">Stuffers Given</label>
            <input type="number" id="stuffersGiven" class="form-control form-control-lg text-center" min="0" value="0">
          </div>
        </div>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info btn-lg px-5" onclick="saveAndPrintBagLabels()">Print Labels & Save</button>
      </div>
    </div>
  </div>
</div>

<!-- PICKUP MODAL -->
<div class="modal fade" id="pickupModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5>Family is Picking Up</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <h3>#<span id="pickupControl"></span></h3>
        <h4>Bin: <span id="pickupBin"></span></h4>
        <p class="lead">Print pickup card?</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-success btn-lg" onclick="printPickupCard()">Print & Complete</button>
      </div>
    </div>
  </div>
</div>